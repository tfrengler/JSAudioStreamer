<!DOCTYPE html>
<html lang="en">

	<head>
		<title>DTP Player</title>
		<meta content="text/html; charset=utf-8" http-equiv="Content-Type" />
        <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no" />

        <style>
            .AudioTrack:hover {
                cursor: pointer;
                background-color: aquamarine;
            }

            .playing {
                background-color: cornflowerblue;
                color: white;
            }

            fieldset {
                display: inline-block;
                vertical-align: top;
            }

            th {
                text-align: left;
            }

            table {
                display: inline-table;
                border-collapse: separate;
            }

            table:first-of-type {
                border-right: 0.1rem solid grey;
                margin-right: 1rem;
                padding-right: 1rem;
            }

            /* tr {
                border-bottom: 0.1rem solid grey;
            } */
        </style>

        <script type="module" src="main.js" ></script>
        
        <script type="module">
            // REPLAY GAIN
            /*
                // Create a MediaElementAudioSourceNode
                // Feed the HTMLMediaElement into it
                var source = audioCtx.createMediaElementSource(AudioTag);

                // Create a gain node
                var gainNode = audioCtx.createGain();
                gainNode.gain.value = desired_gain;

                // connect the AudioBufferSourceNode to the gainNode
                // and the gainNode to the destination
                source.connect(gainNode);
                gainNode.connect(audioCtx.destination);
            */

            // https://developer.mozilla.org/en-US/docs/Web/API/AudioContext/createMediaElementSource
            // https://stackoverflow.com/questions/22604500/web-audio-api-working-with-decibels
            // decibel_level = 20 * Math.log10( gain.value );
            // gain.value = Math.pow(10, (decibel_level / 20));

            // M4A-files
            /*
                These need to be properly fragmented, which most of ours aren't.
                This can be done using mp4fragment (https://www.bento4.com/documentation/mp4fragment/)
                which is a commandline-tool like this:

                mp4fragment --track "audio" "input_file_name.m4a" "output_file_name.m4a"

                https://developer.mozilla.org/en-US/docs/Web/API/Media_Source_Extensions_API/Transcoding_assets_for_MSE
            */

            /* BYTES PER SECOND
                (bitrate * duration) / 8 = size_of_payload
                bitrate / 8 = bytes_per_second
            */

            const UICreateAlbums = function() {
                let output = `<fieldset class="Album">
                    <legend data-album="" >ALBUM 1:</legend>
                    <ol class="AlbumTrackList">
                        <li class="PlaylistEntry" >
                            <span data-trackid="XXX" class="AudioTrack">XXX</span>
                            <input data-trackid="XXX" type="checkbox">
                        </li>
                    </ol>
                </fieldset>`;

                let rootElement = document.getElementById("AlbumList");
                let albums = {};

                for (var albumName in albums) {
                    let fieldSet = document.createElement("fieldset");
                    fieldSet.classList.add("Album");
                    
                    let legend = document.createElement("legend");
                    legend.dataset.album = albumName;
                    legend.innerText = albumName;
                    
                    let ol = document.createElement("ol");
                    ol.classList.add("AlbumTrackList");

                    fieldSet.appendChild(legend);
                    fieldSet.appendChild(ol);

                    albums[albumName].forEach(trackID=> {
                        let trackData = MasterAudioTrackIndex[trackID];

                        let li = document.createElement("li");
                        li.classList.add("PlaylistEntry");

                        let span = document.createElement("span");
                        span.classList.add("AudioTrack");
                        span.dataset.trackid = trackID;
                        span.innerText = trackData.Title;

                        let checkbox = document.createElement("input");
                        checkbox.type = "checkbox";
                        checkbox.dataset.trackid = trackID;

                        li.appendChild(checkbox);
                        li.appendChild(span);
                        ol.appendChild(li);
                    });

                    rootElement.appendChild(fieldSet);
                }
            };
        </script>

    </head>

    <body>
        <button id="UI_Previous">PREVIOUS</button>
        <span>&nbsp;|&nbsp;</span>
        <button id="UI_Play">PLAY</button>
        <button id="UI_Pause">PAUSE</button>
        <button id="UI_Mute">MUTE</button>
        <span>&nbsp;|&nbsp;</span>
        <button id="UI_Next">PREVIOUS</button>

        <p>
            <span id="UI_Volume" >100%</span>
            <span>|</span>
            <input id="UI_Volume_Slider" type="range" min="0.1" max="1.0" step="0.1" value="1.0" />
            <span>|</span>
            <span id="UI_Player_State" >N/A</span> <!--- playing, muted, paused -->
        </p>

        <table>
            <tbody>
                <tr>
                    <th>Play cursor: </th>
                    <td id="UI_PlayCursor">00:00</td>
                </tr>
                <tr>
                    <th>Duration: </th>
                    <td id="UI_Duration">0 | 0</td>
                </tr>
                <tr>
                    <th>Buffered until: </th>
                    <td id="UI_Buffered_Until">00:00</td>
                </tr>
                <tr>
                    <th>Buffered from: </th>
                    <td id="UI_Buffer_Tail">00:00</td>
                </tr>
                <tr>
                    <th>Buffer: </th>
                    <td><meter id="UI_Audio_Buffer" high="0" low="0" max="0" value="0"></meter> <span id="UI_Audio_Buffer_Limit">0</span></td>
                </tr>
                <tr>
                    <th>Bytes read: </th>
                    <td><progress id="UI_Datastream_Progress" max="0" value="0"></progress> <span id="UI_Datastream_BytesRead">0</span></td>
                </tr>
                <tr>
                    <th>Bytes expected: </th>
                    <td id="UI_Datastream_BytesExpected">0</td>
                </tr>
                <tr>
                    <th>AudioObject state: </th>
                    <td id="UI_AudioObject_State">N/A</td>
                </tr>
                <tr>
                    <th>Datastream state: </th>
                    <td id="UI_Datastream_State">N/A</td>
                </tr>
                <tr>
                    <th>Error: </th>
                    <td id="UI_Error">N/A</td>
                </tr>
            </tbody>
        <table>

        <table>
            <tbody>
                <tr>
                    <th>TrackID</th>
                    <td id="UI_TrackID">N/A</td>
                </tr>
                <tr>
                    <th>Title</th>
                    <td id="UI_Title">N/A</td>
                </tr>
                <tr>
                    <th>Album</th>
                    <td id="UI_Album">N/A</td>
                </tr>
                <!-- <tr>
                    <th>AlbumArtists</th>
                    <td>N/A</td>
                </tr> -->
                <tr>
                    <th>TrackArtists</th>
                    <td id="UI_TrackArtists">N/A</td>
                </tr>
                <tr>
                    <th>Year</th>
                    <td id="UI_Year">N/A</td>
                </tr>
                <tr>
                    <th>Genres</th>
                    <td id="UI_Genres">N/A</td>
                </tr>
                <tr>
                    <th>Duration</th>
                    <td id="UI_Duration">N/A</td>
                </tr>
                <tr>
                    <th>Mimetype</th>
                    <td id="UI_Mimetype">N/A</td>
                </tr>
                <tr>
                    <th>Size</th>
                    <td id="UI_Size">N/A</td>
                </tr>
                <tr>
                    <th>ReplayGain</th>
                    <td id="UI_ReplayGain">N/A</td>
                </tr>
            </tbody>
        </table>

        <hr/>
        <h2>MUSIC:</h2>

        <section id="AlbumList"></section>
            <fieldset class="Album">
                <legend data-album="" >ALBUM 1: </legend>
                <a href="#" class="ToggleAlbum" >EXPAND</a>

                <ol class="AlbumTrackList" style="display: block;" >
                    <li class="PlaylistEntry" >
                        <span data-trackid="XXX" class="AudioTrack">Song1</span>
                        <input data-trackid="XXX" type="checkbox">
                    </li>
                    <li class="PlaylistEntry" >
                        <span data-trackid="XXX" class="AudioTrack">Song2</span>
                        <input data-trackid="XXX" type="checkbox">
                    </li>
                    <li class="PlaylistEntry" >
                        <span data-trackid="XXX" class="AudioTrack">Song3</span>
                        <input data-trackid="XXX" type="checkbox">
                    </li>
                </ol>
            </fieldset>
        <hr/>
        <section id="LogOutput"></section>
    </body>
</html>